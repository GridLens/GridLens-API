<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridLens Smart MeterIQ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0f1a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: #94a3b8;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .nav {
            background: #0f172a;
            padding: 0 30px;
            display: flex;
            gap: 0;
            border-bottom: 1px solid #1e293b;
        }
        .nav-item {
            padding: 15px 25px;
            color: #94a3b8;
            text-decoration: none;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-item:hover {
            color: #e2e8f0;
            background: #1e293b;
        }
        .nav-item.active {
            color: #60a5fa;
            border-bottom-color: #3b82f6;
            background: #1e293b;
        }
        .main {
            padding: 25px 30px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .page-subtitle {
            color: #64748b;
            margin-bottom: 25px;
        }
        .fallback-banner {
            background: #fbbf24;
            color: #1a1a1a;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        .fallback-banner.visible {
            display: block;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .kpi-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #3b82f6, #60a5fa);
        }
        .kpi-card.success::before { background: linear-gradient(180deg, #22c55e, #4ade80); }
        .kpi-card.warning::before { background: linear-gradient(180deg, #f59e0b, #fbbf24); }
        .kpi-card.danger::before { background: linear-gradient(180deg, #ef4444, #f87171); }
        .kpi-label {
            font-size: 0.8rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #f8fafc;
        }
        .kpi-trend {
            font-size: 0.8rem;
            margin-top: 8px;
            color: #94a3b8;
        }
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .card {
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
            overflow: hidden;
        }
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title {
            font-weight: 600;
            font-size: 1rem;
        }
        .card-body {
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 10px 12px;
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #334155;
        }
        td {
            padding: 12px;
            font-size: 0.875rem;
            border-bottom: 1px solid #1e3a5f;
        }
        tr:hover td {
            background: #0f172a;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-critical { background: #7f1d1d; color: #fca5a5; }
        .badge-high { background: #78350f; color: #fcd34d; }
        .badge-medium { background: #1e3a5f; color: #93c5fd; }
        .badge-low { background: #14532d; color: #86efac; }
        .badge-open { background: #1e40af; color: #93c5fd; }
        .badge-assigned { background: #7c3aed; color: #c4b5fd; }
        .badge-in_progress { background: #0e7490; color: #67e8f9; }
        .badge-closed { background: #166534; color: #86efac; }
        .page { display: none; }
        .page.active { display: block; }
        .chart-container {
            position: relative;
            height: 250px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .executive-strip {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .exec-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px 16px;
            min-width: 160px;
        }
        .exec-indicator .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f8fafc;
        }
        .exec-indicator .label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .exec-indicator .sublabel {
            font-size: 0.65rem;
            color: #475569;
        }
        .exec-indicator.success .value { color: #22c55e; }
        .exec-indicator.warning .value { color: #f59e0b; }
        .exec-indicator.danger .value { color: #ef4444; }
        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .confidence-badge.high { background: #14532d; color: #86efac; }
        .confidence-badge.degraded { background: #78350f; color: #fcd34d; }
        .confidence-badge.partial { background: #7f1d1d; color: #fca5a5; }
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .trend-indicator.up { background: #7f1d1d33; color: #fca5a5; }
        .trend-indicator.down { background: #14532d33; color: #86efac; }
        .trend-indicator.stable { background: #1e3a5f33; color: #93c5fd; }
        .read-age-bar {
            display: flex;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 6px;
        }
        .read-age-bar .segment { transition: width 0.3s ease; }
        .read-age-bar .fresh { background: #22c55e; }
        .read-age-bar .recent { background: #f59e0b; }
        .read-age-bar .stale { background: #ef4444; }
    </style>
</head>
<body>
    <div class="fallback-banner" id="fallbackBanner">Sample Data (API Unavailable)</div>
    
    <header class="header">
        <div class="logo">
            <div class="logo-icon">G</div>
            <span class="logo-text">GridLens Smart MeterIQ</span>
        </div>
        <div class="header-status">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Live</span>
            </div>
            <div class="status-indicator">
                Last Updated: <strong id="lastUpdated">--</strong>
            </div>
        </div>
    </header>

    <nav class="nav">
        <a class="nav-item active" data-page="system-health">System Health</a>
        <a class="nav-item" data-page="ami-performance">AMI Health & Performance</a>
        <a class="nav-item" data-page="events">Events & Outages</a>
        <a class="nav-item" data-page="fieldops">FieldOps Queue</a>
    </nav>

    <main class="main">
        <!-- System Health Page -->
        <div id="page-system-health" class="page active">
            <h1 class="page-title">System Health Overview</h1>
            <p class="page-subtitle">Fleet-wide AMI status and reporting metrics</p>
            
            <div class="executive-strip" id="systemHealthExec"></div>
            
            <div class="kpi-grid" id="systemHealthKpis"></div>
            
            <div class="content-grid">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Fleet Reporting Status (Last 24h)</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="reportingChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Feeder Health Summary</span>
                    </div>
                    <div class="card-body">
                        <div id="feederHealthTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AMI Health & Performance Page -->
        <div id="page-ami-performance" class="page">
            <h1 class="page-title">AMI Health & Performance</h1>
            <p class="page-subtitle">Read success rates, voltage compliance, and exception feeders</p>
            
            <div class="executive-strip" id="amiExec"></div>
            
            <div class="kpi-grid" id="amiKpis"></div>
            
            <div class="content-grid">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Read Success Rate (7-Day Trend)</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="readSuccessChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Top Exception Feeders</span>
                    </div>
                    <div class="card-body">
                        <div id="exceptionFeedersTable"></div>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <span class="card-title">Low Voltage Meters (Last Interval)</span>
                </div>
                <div class="card-body">
                    <div id="lowVoltageTable"></div>
                </div>
            </div>
        </div>

        <!-- Events & Outages Page -->
        <div id="page-events" class="page">
            <h1 class="page-title">Events & Outages</h1>
            <p class="page-subtitle">Active events, timeline, and feeder impact analysis</p>
            
            <div class="kpi-grid" id="eventsKpis"></div>
            
            <div class="content-grid">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Active Events</span>
                    </div>
                    <div class="card-body">
                        <div id="activeEventsTable"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Event Timeline (Last 24h)</span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="eventTimelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FieldOps Queue Page -->
        <div id="page-fieldops" class="page">
            <h1 class="page-title">FieldOps Queue</h1>
            <p class="page-subtitle">Work orders, priorities, and SLA tracking</p>
            
            <div class="kpi-grid" id="fieldopsKpis"></div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Active Work Orders</span>
                </div>
                <div class="card-body">
                    <div id="workOrdersTable"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = '';
        const TENANT_ID = 'DEMO_TENANT';
        const POLL_INTERVAL = 30000;
        
        let charts = {};
        let currentPage = 'system-health';
        let apiAvailable = true;
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                const pageId = item.dataset.page;
                currentPage = pageId;
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(`page-${pageId}`).classList.add('active');
                
                refreshCurrentPage();
            });
        });
        
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }
        
        function showFallbackBanner(show) {
            document.getElementById('fallbackBanner').classList.toggle('visible', show);
            document.getElementById('statusDot').style.background = show ? '#f59e0b' : '#22c55e';
            document.getElementById('statusText').textContent = show ? 'Sample Data' : 'Live';
            apiAvailable = !show;
        }
        
        async function fetchApi(endpoint) {
            try {
                const res = await fetch(`${API_BASE}${endpoint}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                showFallbackBanner(false);
                return data;
            } catch (err) {
                console.error(`API error (${endpoint}):`, err);
                showFallbackBanner(true);
                return null;
            }
        }
        
        async function refreshSystemHealth() {
            const [quickcheck, scaleStatus, derived] = await Promise.all([
                fetchApi(`/api/ami/kpi/quickcheck?tenantId=${TENANT_ID}`),
                fetchApi(`/api/ami/scale/status?tenantId=${TENANT_ID}`),
                fetchApi(`/api/kpi/derived/all?tenantId=${TENANT_ID}`)
            ]);
            
            if (!quickcheck) return;
            
            const execStrip = document.getElementById('systemHealthExec');
            if (derived) {
                const mhi = derived.meterHealthIndex || {};
                const dc = derived.dataConfidence || {};
                const be = derived.billingExposure || {};
                const readAge = derived.lastGoodReadAge?.distribution || {};
                
                execStrip.innerHTML = `
                    <div class="exec-indicator ${mhi.statusColor || 'success'}">
                        <div class="value">${mhi.systemHealthIndex || 85}</div>
                        <div>
                            <div class="label">Health Index</div>
                            <div class="sublabel">${mhi.status || 'Good'}</div>
                        </div>
                    </div>
                    <div class="exec-indicator">
                        <span class="confidence-badge ${(dc.status || 'high').toLowerCase()}">${dc.status || 'High'}</span>
                        <div>
                            <div class="label">Data Confidence</div>
                            <div class="sublabel">${dc.coveragePct || 100}% coverage</div>
                        </div>
                    </div>
                    <div class="exec-indicator ${be.estimatedDailyExposure > 500 ? 'danger' : be.estimatedDailyExposure > 100 ? 'warning' : 'success'}">
                        <div class="value">$${(be.estimatedDailyExposure || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                        <div>
                            <div class="label">Est. Daily Exposure</div>
                            <div class="sublabel">${be.affectedMeterCount || 0} affected meters</div>
                        </div>
                    </div>
                    <div class="exec-indicator">
                        <div>
                            <div class="label">Read Age Distribution</div>
                            <div class="read-age-bar">
                                <div class="segment fresh" style="width: ${readAge.within15min?.pct || 100}%"></div>
                                <div class="segment recent" style="width: ${readAge.within60min?.pct || 0}%"></div>
                                <div class="segment stale" style="width: ${readAge.over60min?.pct || 0}%"></div>
                            </div>
                            <div class="sublabel">${readAge.within15min?.pct || 100}% fresh | ${readAge.over60min?.pct || 0}% stale</div>
                        </div>
                    </div>
                `;
            }
            
            const kpis = document.getElementById('systemHealthKpis');
            const rs = quickcheck.reportingSummary || {};
            const es = quickcheck.executiveSummary || {};
            
            kpis.innerHTML = `
                <div class="kpi-card success">
                    <div class="kpi-label">Total Fleet Size</div>
                    <div class="kpi-value">${(scaleStatus?.totalDistinctMeters || rs.expectedMeters || 0).toLocaleString()}</div>
                    <div class="kpi-trend">Electric meters in service</div>
                </div>
                <div class="kpi-card ${rs.readSuccessRatePct >= 95 ? 'success' : rs.readSuccessRatePct >= 80 ? 'warning' : 'danger'}">
                    <div class="kpi-label">Read Success Rate</div>
                    <div class="kpi-value">${rs.readSuccessRatePct || 0}%</div>
                    <div class="kpi-trend">Last ${rs.intervalMinutes || 15}-minute interval</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Meters Reporting</div>
                    <div class="kpi-value">${(rs.distinctMetersSeenLastInterval || 0).toLocaleString()}</div>
                    <div class="kpi-trend">Last interval reads</div>
                </div>
                <div class="kpi-card ${es.lowVoltageReadsPct > 5 ? 'danger' : es.lowVoltageReadsPct > 1 ? 'warning' : 'success'}">
                    <div class="kpi-label">Low Voltage Reads</div>
                    <div class="kpi-value">${es.lowVoltageReadsPct || 0}%</div>
                    <div class="kpi-trend">Below 114V threshold</div>
                </div>
            `;
            
            renderReportingChart(quickcheck);
            renderFeederHealthTable(quickcheck);
        }
        
        function renderReportingChart(data) {
            const ctx = document.getElementById('reportingChart');
            if (!ctx) return;
            
            const rs = data.reportingSummary || {};
            const reporting = rs.distinctMetersSeenLastInterval || 0;
            const expected = rs.expectedMeters || 25000;
            const missing = expected - reporting;
            
            if (charts.reporting) charts.reporting.destroy();
            charts.reporting = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Reporting', 'Not Reporting'],
                    datasets: [{
                        data: [reporting, missing],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                    }
                }
            });
        }
        
        function renderFeederHealthTable(data) {
            const container = document.getElementById('feederHealthTable');
            const feeders = data.topExceptionFeeders || [];
            
            if (feeders.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#9989;</div><p>All feeders healthy - no exceptions detected</p></div>`;
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead><tr><th>Feeder</th><th>Exception Score</th><th>Low Voltage</th><th>Missing Reads</th></tr></thead>
                    <tbody>
                        ${feeders.slice(0, 10).map(f => `
                            <tr>
                                <td><strong>${f.feederId}</strong></td>
                                <td>${f.exceptionScore}</td>
                                <td>${f.lowVoltageReads || 0}</td>
                                <td>${f.missingReads || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        async function refreshAmiPerformance() {
            const [quickcheck, derived] = await Promise.all([
                fetchApi(`/api/ami/kpi/quickcheck?tenantId=${TENANT_ID}`),
                fetchApi(`/api/kpi/derived/all?tenantId=${TENANT_ID}`)
            ]);
            if (!quickcheck) return;
            
            const execStrip = document.getElementById('amiExec');
            if (derived) {
                const ev = derived.exceptionVelocity || {};
                const mhi = derived.meterHealthIndex || {};
                const readAge = derived.lastGoodReadAge || {};
                const dc = derived.dataConfidence || {};
                
                const trendClass = ev.trend === 'increasing' ? 'up' : ev.trend === 'decreasing' ? 'down' : 'stable';
                
                execStrip.innerHTML = `
                    <div class="exec-indicator ${mhi.statusColor || 'success'}">
                        <div class="value">${mhi.systemHealthIndex || 85}</div>
                        <div>
                            <div class="label">Meter Health Index</div>
                            <div class="sublabel">${mhi.distribution?.critical || 0} critical</div>
                        </div>
                    </div>
                    <div class="exec-indicator ${ev.severity === 'critical' ? 'danger' : ev.severity === 'elevated' ? 'warning' : 'success'}">
                        <div class="value">${ev.currentIntervalCount || 0}</div>
                        <div>
                            <div class="label">Exception Velocity</div>
                            <div class="sublabel">
                                <span class="trend-indicator ${trendClass}">${ev.trendIcon || 'â†’'} ${ev.changeVsPriorPct || 0}% vs prior</span>
                            </div>
                        </div>
                    </div>
                    <div class="exec-indicator">
                        <div class="value">${readAge.freshReadsPct || 100}%</div>
                        <div>
                            <div class="label">Fresh Reads</div>
                            <div class="sublabel">&lt;15 min old</div>
                        </div>
                    </div>
                    <div class="exec-indicator">
                        <span class="confidence-badge ${(dc.status || 'high').toLowerCase()}">${dc.status || 'High'}</span>
                        <div>
                            <div class="label">Data Confidence</div>
                            <div class="sublabel">${dc.message || 'All systems nominal'}</div>
                        </div>
                    </div>
                `;
            }
            
            const kpis = document.getElementById('amiKpis');
            const es = quickcheck.executiveSummary || {};
            const vc = quickcheck.voltageCompliance || {};
            
            kpis.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Avg Interval kWh</div>
                    <div class="kpi-value">${(es.avgIntervalKwhProxy || 0).toFixed(1)}</div>
                    <div class="kpi-trend">Fleet average per interval</div>
                </div>
                <div class="kpi-card ${vc.lowVoltageReadsPct > 5 ? 'danger' : vc.lowVoltageReadsPct > 1 ? 'warning' : 'success'}">
                    <div class="kpi-label">Voltage Compliance</div>
                    <div class="kpi-value">${(100 - (vc.lowVoltageReadsPct || 0)).toFixed(1)}%</div>
                    <div class="kpi-trend">${vc.lowVoltageReadsPct || 0}% below threshold</div>
                </div>
                <div class="kpi-card ${es.topExceptionFeeder ? 'warning' : 'success'}">
                    <div class="kpi-label">Top Exception Feeder</div>
                    <div class="kpi-value">${es.topExceptionFeeder || 'None'}</div>
                    <div class="kpi-trend">Highest exception score</div>
                </div>
                <div class="kpi-card success">
                    <div class="kpi-label">Read Success</div>
                    <div class="kpi-value">${es.readSuccessRatePct || 100}%</div>
                    <div class="kpi-trend">Last interval</div>
                </div>
            `;
            
            renderExceptionFeedersTable(quickcheck);
            renderLowVoltageTable(quickcheck);
        }
        
        function renderExceptionFeedersTable(data) {
            const container = document.getElementById('exceptionFeedersTable');
            const feeders = data.topExceptionFeeders || [];
            
            if (feeders.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#9989;</div><p>No exception feeders detected</p></div>`;
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead><tr><th>Feeder</th><th>Score</th><th>Status</th></tr></thead>
                    <tbody>
                        ${feeders.slice(0, 8).map(f => `
                            <tr>
                                <td><strong>${f.feederId}</strong></td>
                                <td>${f.exceptionScore}</td>
                                <td><span class="badge ${f.exceptionScore > 50 ? 'badge-critical' : f.exceptionScore > 20 ? 'badge-high' : 'badge-medium'}">
                                    ${f.exceptionScore > 50 ? 'Critical' : f.exceptionScore > 20 ? 'High' : 'Monitor'}
                                </span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderLowVoltageTable(data) {
            const container = document.getElementById('lowVoltageTable');
            const meters = data.voltageCompliance?.lowVoltageMetersLast10 || [];
            
            if (meters.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#9889;</div><p>All meters within voltage tolerance</p></div>`;
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead><tr><th>Meter ID</th><th>Feeder</th><th>Voltage</th><th>Read Time</th></tr></thead>
                    <tbody>
                        ${meters.map(m => `
                            <tr>
                                <td><strong>${m.meter_id}</strong></td>
                                <td>${m.feeder_id}</td>
                                <td><span class="badge ${m.voltage < 108 ? 'badge-critical' : 'badge-high'}">${m.voltage}V</span></td>
                                <td>${new Date(m.read_at).toLocaleTimeString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        async function refreshEvents() {
            const [events, quickcheck] = await Promise.all([
                fetchApi(`/api/ami/events/active?tenantId=${TENANT_ID}`),
                fetchApi(`/api/ami/kpi/quickcheck?tenantId=${TENANT_ID}`)
            ]);
            
            const kpis = document.getElementById('eventsKpis');
            const activeEvents = events?.events || [];
            
            kpis.innerHTML = `
                <div class="kpi-card ${activeEvents.length > 5 ? 'danger' : activeEvents.length > 0 ? 'warning' : 'success'}">
                    <div class="kpi-label">Active Events</div>
                    <div class="kpi-value">${activeEvents.length}</div>
                    <div class="kpi-trend">Currently impacting grid</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Voltage Events</div>
                    <div class="kpi-value">${activeEvents.filter(e => e.event_type === 'voltage-sag').length}</div>
                    <div class="kpi-trend">Active voltage sags</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Comms Outages</div>
                    <div class="kpi-value">${activeEvents.filter(e => e.event_type === 'comms-outage').length}</div>
                    <div class="kpi-trend">Active communication issues</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Feeders Impacted</div>
                    <div class="kpi-value">${new Set(activeEvents.map(e => e.feeder_id)).size}</div>
                    <div class="kpi-trend">Unique feeders with events</div>
                </div>
            `;
            
            renderActiveEventsTable(activeEvents);
            renderEventTimeline(activeEvents);
        }
        
        function renderActiveEventsTable(events) {
            const container = document.getElementById('activeEventsTable');
            
            if (!events || events.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#9989;</div><p>No active events - grid operating normally</p></div>`;
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead><tr><th>Event Type</th><th>Feeder</th><th>Severity</th><th>Started</th><th>Ends</th></tr></thead>
                    <tbody>
                        ${events.map(e => `
                            <tr>
                                <td><strong>${e.event_type}</strong></td>
                                <td>${e.feeder_id}</td>
                                <td><span class="badge ${parseFloat(e.severity) > 0.7 ? 'badge-critical' : parseFloat(e.severity) > 0.4 ? 'badge-high' : 'badge-medium'}">
                                    ${(parseFloat(e.severity) * 100).toFixed(0)}%
                                </span></td>
                                <td>${new Date(e.start_at).toLocaleTimeString()}</td>
                                <td>${new Date(e.end_at).toLocaleTimeString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderEventTimeline(events) {
            const ctx = document.getElementById('eventTimelineChart');
            if (!ctx) return;
            
            const eventTypes = ['voltage-sag', 'comms-outage', 'theft'];
            const counts = eventTypes.map(type => events.filter(e => e.event_type === type).length);
            
            if (charts.eventTimeline) charts.eventTimeline.destroy();
            charts.eventTimeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Voltage Sag', 'Comms Outage', 'Theft Suspected'],
                    datasets: [{
                        data: counts,
                        backgroundColor: ['#f59e0b', '#3b82f6', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' } },
                        x: { ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }
        
        async function refreshFieldOps() {
            const data = await fetchApi(`/api/fieldops/queue?tenantId=${TENANT_ID}`);
            if (!data) return;
            
            const kpis = document.getElementById('fieldopsKpis');
            const stats = data.stats || {};
            const queue = data.queue || [];
            
            kpis.innerHTML = `
                <div class="kpi-card ${stats.openCount > 20 ? 'danger' : stats.openCount > 10 ? 'warning' : 'success'}">
                    <div class="kpi-label">Open Work Orders</div>
                    <div class="kpi-value">${stats.openCount || 0}</div>
                    <div class="kpi-trend">Awaiting assignment</div>
                </div>
                <div class="kpi-card ${stats.criticalCount > 0 ? 'danger' : 'success'}">
                    <div class="kpi-label">Critical Priority</div>
                    <div class="kpi-value">${stats.criticalCount || 0}</div>
                    <div class="kpi-trend">Requires immediate action</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">In Progress</div>
                    <div class="kpi-value">${stats.inProgressCount || 0}</div>
                    <div class="kpi-trend">Currently being worked</div>
                </div>
                <div class="kpi-card warning">
                    <div class="kpi-label">Est. Revenue at Risk</div>
                    <div class="kpi-value">$${(stats.totalOpenLoss || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                    <div class="kpi-trend">Open work orders</div>
                </div>
            `;
            
            renderWorkOrdersTable(queue);
        }
        
        function renderWorkOrdersTable(queue) {
            const container = document.getElementById('workOrdersTable');
            
            if (!queue || queue.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#9989;</div><p>No active work orders - all issues resolved</p></div>`;
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead><tr><th>ID</th><th>Issue</th><th>Feeder</th><th>Priority</th><th>Status</th><th>Age</th><th>Est. Loss</th></tr></thead>
                    <tbody>
                        ${queue.map(wo => `
                            <tr>
                                <td><strong>#${wo.id}</strong></td>
                                <td>${wo.issueCode || wo.issueType}</td>
                                <td>${wo.feeder}</td>
                                <td><span class="badge badge-${wo.priority}">${wo.priority}</span></td>
                                <td><span class="badge badge-${wo.status}">${wo.status}</span></td>
                                <td>${wo.ageDays}d</td>
                                <td>$${(wo.estLossDollars || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        async function refreshCurrentPage() {
            updateTimestamp();
            
            switch (currentPage) {
                case 'system-health':
                    await refreshSystemHealth();
                    break;
                case 'ami-performance':
                    await refreshAmiPerformance();
                    break;
                case 'events':
                    await refreshEvents();
                    break;
                case 'fieldops':
                    await refreshFieldOps();
                    break;
            }
        }
        
        refreshCurrentPage();
        
        setInterval(refreshCurrentPage, POLL_INTERVAL);
    </script>
</body>
</html>
